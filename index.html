<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayalingo</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.svg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* GLOBAL FONTS & COLORS */
        :root {
            --primary: #2c3e50; 
            --accent: #27ae60;  
            --light: #ecf0f1;
            --step-active: #3498db; 
            --blur-bg: #dfe6e9;
        }

        * { box-sizing: border-box; }

        body, button, select, input, h1, h2, h3, h4, div, span, p, li, a {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        /* FULL HEIGHT LAYOUT */
        html, body { 
            margin: 0; padding: 0; 
            background: #f4f7f6; color: #333; 
            height: 100%; overflow: hidden; 
        }
        
        .container { 
            max-width: 800px; 
            height: 100%; 
            margin: 0 auto; 
            background: white;
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #e0e0e0;
            border-right: 1px solid #e0e0e0;
        }
        
        /* HEADER */
        header { 
            background: var(--primary); color: white; padding: 1rem; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10;
            flex-shrink: 0;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
        }
        header h2 { margin: 0; font-weight: 700; letter-spacing: 1px; text-align: center; grid-column: 2; }
        .header-right { grid-column: 3; text-align: right; }

        .exit-btn {
            background: rgba(255,255,255,0.1); color: #ecf0f1; border: 1px solid rgba(255,255,255,0.2); 
            padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; display: none;
        }
        .exit-btn:hover { background: rgba(255,255,255,0.2); color: white; }

        /* PROGRESS BAR */
        .progress-container { width: 100%; background-color: #ecf0f1; height: 8px; flex-shrink: 0; display:none; }
        .progress-bar { height: 100%; background-color: var(--accent); width: 0%; transition: width 0.3s ease; }

        /* SCROLLABLE CONTENT AREA */
        #scroll-viewport {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        /* ACTION BAR (Fixed Bottom) */
        #action-bar {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between; 
            align-items: center;
            min-height: 70px;
        }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; width: 100%; margin-bottom: 20px; }
        .lesson-card {
            background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e0e0e0;
            cursor: pointer; transition: transform 0.1s; text-align: center; position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 120px;
        }
        .lesson-card:active { transform: translateY(2px); background: #f9f9f9; }
        .lesson-card h3 { margin: 0; font-size: 1.1rem; color: var(--primary); font-weight: 600; }
        .lesson-card .status { font-size: 0.75rem; color: var(--accent); margin-top: 5px; text-transform: uppercase; font-weight: bold; }
        .lesson-card.completed { border-color: var(--accent); background: #f0fdf4; }
        .checkmark { position: absolute; top: 10px; right: 10px; color: var(--accent); font-weight: bold; font-size: 1.2rem; display: none; }
        .lesson-card.completed .checkmark { display: block; }
        
        .lesson-card.review-card { border-color: var(--step-active); background: #f0f8ff; }
        .lesson-card.review-card h3 { color: var(--step-active); }

        /* NARRATOR */
        #narrator-box { 
            background: #f8f9fa; color: #2c3e50; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dfe6e9;
            font-size: 0.95rem; display: none; align-items: center; gap: 10px; cursor: pointer; flex-shrink: 0;
        }
        .tts-label { font-weight: bold; text-transform: uppercase; font-size: 0.7rem; color: #7f8c8d; }
        .skip-hint { font-size: 0.7rem; color: #bdc3c7; margin-left: auto; }

        /* CHAT VIEW */
        .chat-container { width: 100%; }
        .chat-row { margin-bottom: 15px; padding: 15px; border-radius: 12px; width: 85%; border: 1px solid #f0f0f0; transition: all 0.3s; }
        .chat-row.active-playing { border-color: var(--step-active); box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: scale(1.02); }
        .speaker-label { font-size: 0.7em; font-weight: 700; color: #95a5a6; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }

        /* Dynamic Speaker Styles */
        .chat-row.left-aligned { margin-right: auto; border-left-width: 5px; border-left-style: solid; border-right: none; }
        .chat-row.right-aligned { margin-left: auto; border-right-width: 5px; border-right-style: solid; border-left: none; }

        .sp-style-0 { background: #e8f8f5; border-color: #1abc9c; } /* Teal */
        .sp-style-1 { background: #fef9e7; border-color: #f1c40f; } /* Yellow */
        .sp-style-2 { background: #f4ecf7; border-color: #9b59b6; } /* Purple */
        .sp-style-3 { background: #ebf5fb; border-color: #3498db; } /* Blue */
        .sp-style-4 { background: #fdedec; border-color: #e74c3c; } /* Red */
        .sp-style-5 { background: #eaeded; border-color: #95a5a6; } /* Grey */

        /* CARD VIEW */
        .card-view { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; flex-grow: 1; }
        
        .narrator-slide { background: white; border-left: 5px solid var(--step-active); padding: 25px; border-radius: 8px; font-size: 1.2rem; line-height: 1.5; color: var(--primary); max-width: 600px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .hidden-content-box { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer; width: 100%; margin-top: 10px;}
        .hidden-content-box.obscured { background: var(--blur-bg); user-select: none; border-color: transparent; }
        .hidden-content-box.obscured .native-text, .hidden-content-box.obscured .translation, .hidden-content-box.obscured .media-container { visibility: hidden; opacity: 0; }
        .hidden-content-box.revealed .native-text, .hidden-content-box.revealed .translation, .hidden-content-box.revealed .media-container { visibility: visible; opacity: 1; }

        .native-text { font-size: 1.8rem; color: var(--primary); margin: 15px 0; font-weight: 600; }
        .translation { font-size: 1.1rem; color: #7f8c8d; font-style: italic; }
        .prompt-text { font-size: 1.2rem; margin-bottom: 20px; font-weight: 600; color: #333; }
        .reveal-hint { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: #95a5a6; margin-bottom: 5px; opacity: 0; transition: opacity 0.3s; }
        .reveal-hint.visible { opacity: 1; }

        .card-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 15px; object-fit: cover; }
        .media-container { width: 100%; margin-bottom: 10px; max-width: 500px; display: flex; justify-content: center; }
        
        /* ACTION BUTTONS */
        .big-btn { 
            background: var(--primary); color: white; border: none; 
            padding: 12px 30px; border-radius: 8px; cursor: pointer; 
            font-size: 1rem; font-weight: 600; min-width: 120px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s; 
        }
        .big-btn:active { transform: translateY(4px); box-shadow: none; }
        .big-btn.secondary { background: white; color: #7f8c8d; border: 1px solid #ccc; box-shadow: 0 4px 0 #ddd; }
        .big-btn.secondary:active { box-shadow: none; }
        
        /* FOOTER LINKS */
        .reset-link { text-align: center; margin-top: 30px; font-size: 0.8rem; color: #bdc3c7; text-decoration: underline; cursor: pointer; padding-bottom: 10px;}
        .reset-link:hover { color: #e74c3c; }

        .credits-link { text-align: center; font-size: 0.8rem; color: #bdc3c7; text-decoration: underline; cursor: pointer; padding-bottom: 20px; }
        .credits-link:hover { color: var(--primary); }

        #btn-back, #btn-next { visibility: hidden; }

        /* MODAL OVERLAY STYLES */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            width: 450px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease;
        }

        .modal-box h3 {
            color: var(--primary);
            margin-top: 0;
            border-bottom: 2px solid var(--accent);
            display: inline-block;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .modal-box p {
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .modal-close {
            margin-top: 10px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 25px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }
        .modal-close:hover { background: #34495e; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div></div> <h2>Ayalingo</h2>
        <div class="header-right">
            <button id="exit-btn" class="exit-btn" onclick="exitLesson()">Exit</button>
        </div>
    </header>

    <div id="progress-container" class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
    </div>

    <div id="scroll-viewport" class="swipe-area">
        <div id="narrator-box" onclick="skipTTS()">
            <span class="tts-label">Note</span>
            <span id="narrator-text"></span>
            <span class="skip-hint">Tap to skip</span>
        </div>

        <div id="app-content"></div>
        
        <div id="menu-view">
            <div id="menu-grid" class="menu-grid"></div>
            <div class="reset-link" onclick="resetProgress()">Reset Progress</div>
            <div class="credits-link" onclick="showCredits()">Acknowledgements</div>
        </div>
    </div>

    <div id="action-bar" style="display:none;">
        <button id="btn-back" class="big-btn secondary" onclick="handlePrevAction()">Back</button>
        <button id="btn-next" class="big-btn" onclick="handleNextAction()">Next</button>
    </div>
</div>

<div id="credits-modal" class="modal-overlay" onclick="hideCredits(event)">
    <div class="modal-box">
        <h3>Acknowledgements</h3>
        <p>Lessons and recordings from the χʷɛmaɬkʷu First Preliminary Language Text.</p>
        <p style="font-style:italic; font-size: 0.95rem; color: #555;">
            Dr. Susan J. Blake, Mabel Harry, Ernest G. Harry, Jimmy Wilson, Lorraine Harry, Lawrence Harry, and Joanne Francis.
        </p>
        <p style="font-style:italic; font-size: 0.95rem; color: #555;">
            Ayalingo is created by the Homalco Language Team, any mistakes or errors are the sole resposibility of Homalco Language Team. We dedicate this work to our langauge warriors, past and present, who have fought to keep our language alive. čɛčɛhatanapɛst.
        </p>
        <p style="font-style:italic; font-size: 0.95rem; color: #555;">
            Ayalingo is Liscensed under Creative Commons. Anyone can replicate and modify this work for any purpose except commercial. For more information contact dominic.fode@homalco.com
        </p>
        <button class="modal-close" onclick="hideCredits()">Close</button>
    </div>
</div>

<script>
    // --- STATE ---
    let lessonManifest = []; 
    let state = {
        conversationData: [], 
        sequenceData: [],     
        title: "",
        filename: "",
        goalsText: "", 
        phase: null,
        slideIndex: 0
    };

    let autoPlayActive = false; 
    let completedLessons = JSON.parse(localStorage.getItem('ayalingo_progress')) || [];
    let pendingAudioCallback = null; 
    
    // --- TOUCH SUPPORT ---
    let touchStartX = 0;
    let touchEndX = 0;

    document.querySelector('.swipe-area').addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    });

    document.querySelector('.swipe-area').addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    });

    function handleSwipe() {
        const minSwipeDistance = 50; 
        if (state.phase === 'menu') return; 

        if (touchEndX < touchStartX - minSwipeDistance) {
            handleNextAction(); 
        }
        if (touchEndX > touchStartX + minSwipeDistance) {
            handlePrevAction(); 
        }
    }

    // --- INITILIZATION LOADING MANIFEST ---
    window.onload = () => { 
        fetch('manifest.json')
            .then(response => response.json())
            .then(data => {
                lessonManifest = data;
                renderMenu(); 
            })
            .catch(err => {
                console.error("Could not load manifest.json", err);
                document.getElementById('menu-grid').innerHTML = "<p>Error loading lessons.</p>";
            });
    };

    // --- MENU LOGIC ---
    function renderMenu() {
        const grid = document.getElementById('menu-grid');
        grid.innerHTML = "";
        
        lessonManifest.forEach(lesson => {
            const isDone = completedLessons.includes(lesson.file);
            
            const card = document.createElement('div');
            card.className = `lesson-card ${isDone ? 'completed' : ''}`;
            card.onclick = () => loadLesson(lesson);
            
            const statusHtml = isDone ? `<div class="status">COMPLETED</div>` : '';
            card.innerHTML = `<div class="checkmark">✓</div><h3>${lesson.title}</h3>${statusHtml}`;
            grid.appendChild(card);
        });

        if (completedLessons.length > 0) {
            const reviewCard = document.createElement('div');
            reviewCard.className = `lesson-card review-card`;
            reviewCard.onclick = () => startReview();
            reviewCard.innerHTML = `<h3>Review Mode</h3>`;
            grid.appendChild(reviewCard);
        }

        switchView('menu');
    }

    function switchView(viewName) {
        const menuView = document.getElementById('menu-view');
        const appContent = document.getElementById('app-content');
        const progressBar = document.getElementById('progress-container');
        const actionBar = document.getElementById('action-bar');
        const exitBtn = document.getElementById('exit-btn');
        const narratorBox = document.getElementById('narrator-box');

        if (viewName === 'menu') {
            menuView.style.display = 'block';
            appContent.style.display = 'none';
            progressBar.style.display = 'none';
            actionBar.style.display = 'none';
            exitBtn.style.display = 'none';
            narratorBox.style.display = 'none';
        } else {
            menuView.style.display = 'none';
            appContent.style.display = 'block'; 
            progressBar.style.display = 'block';
            actionBar.style.display = 'flex';
            exitBtn.style.display = 'inline-block';
        }
    }

    function exitLesson() {
        stopConversationPlayback();
        cancelTTS();
        switchView('menu');
    }

    function resetProgress() {
        if(confirm("Are you sure you want to reset all progress?")) {
            localStorage.removeItem('ayalingo_progress');
            completedLessons = [];
            renderMenu();
        }
    }

    // --- MODAL LOGIC ---
    function showCredits() {
        document.getElementById('credits-modal').style.display = 'flex';
    }

    function hideCredits(e) {
        if (!e || e.target.id === 'credits-modal' || e.target.classList.contains('modal-close')) {
            document.getElementById('credits-modal').style.display = 'none';
        }
    }

    // --- DATA LOADING ---
    function loadLesson(lessonObj) {
        state.filename = lessonObj.file;
        state.title = lessonObj.title;

        const txtFile = lessonObj.file.replace('.csv', '.txt');
        
        fetch(txtFile).then(r => r.ok ? r.text() : "Goals not found.").then(text => {
            state.goalsText = text;
            Papa.parse(lessonObj.file, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    const raw = results.data;
                    state.conversationData = raw.filter(r => r.type && r.type.toLowerCase().trim() === 'c');
                    state.sequenceData = raw.filter(r => ['p', 'n', 'r', 't'].includes(r.type ? r.type.toLowerCase().trim() : ''));
                    switchView('app');
                    transitionToPhase('goals');
                }
            });
        });
    }

    async function startReview() {
        if (completedLessons.length === 0) return;
        state.filename = "review";
        state.title = "Review";
        state.goalsText = "Reviewing random items.";
        state.conversationData = []; 
        
        let allItems = [];
        for (const file of completedLessons) {
            await new Promise(resolve => {
                Papa.parse(file, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => {
                        const items = res.data.filter(r => ['r', 't'].includes(r.type ? r.type.toLowerCase().trim() : ''));
                        allItems = allItems.concat(items);
                        resolve();
                    }
                });
            });
        }
        allItems.sort(() => 0.5 - Math.random());
        state.sequenceData = allItems.slice(0, 10);

        switchView('app');
        transitionToPhase('goals');
    }

    // --- NAVIGATION ---
    function transitionToPhase(newPhase) {
        stopConversationPlayback();
        cancelTTS();
        state.phase = newPhase;
        state.slideIndex = 0; 
        updateProgressBar();
        render();
    }

    function updateProgressBar() {
        const bar = document.getElementById('progress-bar');
        if (state.phase === 'goals') bar.style.width = '5%';
        else if (state.phase === 'conversation') bar.style.width = '15%';
        else if (state.phase === 'practice') {
            const pct = 15 + ((state.slideIndex / state.sequenceData.length) * 85);
            bar.style.width = `${pct}%`;
        } else if (state.phase === 'finish') bar.style.width = '100%';
    }

    function updateButtons(backVisible, nextLabel) {
        const btnBack = document.getElementById('btn-back');
        const btnNext = document.getElementById('btn-next');
        
        btnBack.style.visibility = backVisible ? 'visible' : 'hidden';
        btnNext.innerText = nextLabel;
        btnNext.style.visibility = 'visible'; 
    }

    function handleNextAction() {
        stopConversationPlayback();
        cancelTTS();

        if (state.phase === 'goals') {
            if(state.conversationData.length > 0) transitionToPhase('conversation');
            else transitionToPhase('practice');
        }
        else if (state.phase === 'conversation') {
            transitionToPhase('practice');
        }
        else if (state.phase === 'practice') {
            if (state.slideIndex < state.sequenceData.length - 1) {
                state.slideIndex++;
                updateProgressBar();
                render();
            } else {
                transitionToPhase('finish');
            }
        }
        else if (state.phase === 'finish') {
            if (state.filename !== 'review' && !completedLessons.includes(state.filename)) {
                completedLessons.push(state.filename);
                localStorage.setItem('ayalingo_progress', JSON.stringify(completedLessons));
            }
            renderMenu(); 
        }
    }

    function handlePrevAction() {
        stopConversationPlayback();
        cancelTTS();
        if (state.phase === 'conversation') {
            transitionToPhase('goals');
        }
        else if (state.phase === 'practice') {
            if (state.slideIndex > 0) {
                state.slideIndex--;
                updateProgressBar();
                render();
            } else {
                if(state.conversationData.length > 0) transitionToPhase('conversation');
                else transitionToPhase('goals');
            }
        }
    }

    document.addEventListener('keydown', (e) => {
        if (document.getElementById('menu-view').style.display === 'block') return;
        if (e.code === 'Space') {
            e.preventDefault();
            const hidden = document.querySelector('.hidden-content-box.obscured');
            if (hidden) hidden.click();
            else playCurrentSlideAudio();
        }
        if (e.code === 'ArrowRight') handleNextAction();
        if (e.code === 'ArrowLeft') handlePrevAction();
    });

    // --- HELPERS ---
    function renderMedia(url) {
        if (!url) return '';
        const ytId = getYoutubeId(url);
        if (ytId) {
            return `<div class="media-container"><iframe width="100%" height="250" src="https://www.youtube.com/embed/${ytId}" frameborder="0" allowfullscreen></iframe></div>`;
        } else {
            return `<div class="media-container"><audio class="slide-audio" controls src="${url}" style="width:100%;"></audio></div>`;
        }
    }

    function getYoutubeId(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function playCurrentSlideAudio() {
        const audio = document.querySelector('.card-view .slide-audio') || document.querySelector('.chat-row.active-playing .slide-audio');
        if (audio) {
            audio.currentTime = 0; 
            audio.play().catch(e => console.log("Audio play blocked", e));
        }
    }

    function startConversationPlayback() {
        autoPlayActive = true;
        setTimeout(() => { playConversationIndex(0); }, 500);
    }
    
    function playConversationIndex(index) {
        if (!autoPlayActive) return;
        const rows = document.querySelectorAll('.chat-row');
        if (index >= rows.length) { autoPlayActive = false; return; }
        
        rows.forEach(r => r.classList.remove('active-playing'));
        const currentRow = rows[index];
        currentRow.classList.add('active-playing');
        
        currentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

        const audio = currentRow.querySelector('audio');
        if (audio) {
            audio.play().then(() => {
                audio.onended = () => { if(autoPlayActive) playConversationIndex(index + 1); };
            }).catch(() => { setTimeout(() => { if(autoPlayActive) playConversationIndex(index + 1); }, 2000); });
        } else {
            setTimeout(() => { if(autoPlayActive) playConversationIndex(index + 1); }, 3000);
        }
    }
    
    function stopConversationPlayback() {
        autoPlayActive = false;
        document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; a.onended = null; });
        document.querySelectorAll('.chat-row').forEach(r => r.classList.remove('active-playing'));
    }

    function speak(text, callback) {
        cancelTTS(); 
        if (!window.speechSynthesis) return;
        pendingAudioCallback = callback;
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.95;
        const voices = window.speechSynthesis.getVoices();
        const fVoice = voices.find(v => v.name.includes('Female') || v.name.includes('Google US English'));
        if (fVoice) u.voice = fVoice;
        u.onend = () => { if (pendingAudioCallback) { pendingAudioCallback(); pendingAudioCallback = null; } };
        window.speechSynthesis.speak(u);
    }
    function cancelTTS() { if (window.speechSynthesis) window.speechSynthesis.cancel(); pendingAudioCallback = null; }
    function skipTTS() { 
        if (window.speechSynthesis && window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
            if (pendingAudioCallback) { pendingAudioCallback(); pendingAudioCallback = null; }
        }
    }
    function revealAndPlay(element) {
        element.classList.remove('obscured'); element.classList.add('revealed');
        const audio = element.querySelector('audio'); 
        if(audio) { audio.currentTime = 0; audio.play().catch(e=>console.log(e)); }
    }

    function revealAndSpeak(element, text) {
        element.classList.remove('obscured'); 
        element.classList.add('revealed');
        if(text) speak(text);
    }
    
    function playAudioThenTTS(text) {
        const audio = document.querySelector('.card-view .slide-audio');
        cancelTTS();
        if(audio) {
            audio.currentTime = 0;
            audio.play().catch(e=>console.log(e));
            audio.addEventListener('ended', () => {
                speak(text);
            }, { once: true });
        } else {
            speak(text);
        }
    }

    // --- MAIN RENDER ---
    function render() {
        const container = document.getElementById('app-content');
        const narratorBox = document.getElementById('narrator-box');
        const narratorEl = document.getElementById('narrator-text');
        
        let textToSpeak = "";
        let html = "";
        let audioCallback = null; 

        narratorBox.style.display = 'none'; 

        // Get custom narrator_text from current row if it exists
        const row = state.phase === 'practice' ? state.sequenceData[state.slideIndex] : 
                    (state.phase === 'conversation' ? state.conversationData[0] : null);
        
        // SINGLE SOURCE OF TRUTH: If 'narrator_text' is present in the CSV, we use it.
        const priorityNarrator = row && row.narrator_text ? row.narrator_text.trim() : "";

        // 1. GOALS
        if (state.phase === 'goals') {
            updateButtons(false, "Start");
            textToSpeak = state.filename === 'review' ? "" : state.goalsText; 
            const formattedGoals = state.goalsText.replace(/\n/g, '<br>');
            html = `<div style="text-align:center;">
                    <h2>Topic: ${state.title}</h2>
                    <div style="font-size:1.1rem; line-height:1.6; margin:20px 0; text-align:left; border: 1px solid #f0f0f0; padding:20px; background:#fafafa; border-radius:12px;">${formattedGoals}</div>
                </div>`;
            if(textToSpeak) narratorBox.style.display = 'flex';
        } 
        // 2. CONVERSATION
        else if (state.phase === 'conversation') {
            updateButtons(true, "Practice");
            
            // PRIORITY: Use narrator_text from first line of conversation if available
            textToSpeak = priorityNarrator || "Listen closely to the conversation.";
            
            if(state.filename === 'review') textToSpeak = "";
            if(textToSpeak) narratorBox.style.display = 'flex';

            const uniqueSpeakers = [];
            state.conversationData.forEach(row => {
                if (row.speaker && !uniqueSpeakers.includes(row.speaker)) {
                    uniqueSpeakers.push(row.speaker);
                }
            });

            html = `<div class="chat-container">`;
            state.conversationData.forEach((row, i) => {
                let spIndex = uniqueSpeakers.indexOf(row.speaker);
                if (spIndex === -1) spIndex = 0;
                const alignClass = (spIndex % 2 === 0) ? 'left-aligned' : 'right-aligned';
                const styleClass = `sp-style-${spIndex % 6}`;
                html += `<div class="chat-row ${alignClass} ${styleClass}" id="row-${i}">
                    <span class="speaker-label">${row.speaker}</span>
                    <div style="font-size:1.1rem; margin-bottom: 5px;">${row.ayajuthem}</div>
                    <div style="font-size:0.9rem; color:#666; margin-bottom: 10px;">${row.english}</div>
                    ${renderMedia(row.audio_url)}
                </div>`;
            });
            html += `</div>`;
            audioCallback = () => { setTimeout(() => { startConversationPlayback(); }, 500); };
        }
        // 3. PRACTICE
        else if (state.phase === 'practice') {
            updateButtons(true, "Next");
            const type = row.type.toLowerCase().trim();

            // PRIORITY RULE: custom narrator_text overrides the standard Slide 0 prompt
            if (priorityNarrator) {
                textToSpeak = priorityNarrator;
            } else if (state.slideIndex === 0 && state.filename !== 'review') {
                textToSpeak = "Now, let's practice."; 
            }

            if (type === 'n') {
                narratorBox.style.display = 'none'; // Narration is the slide content itself
                html = `<div class="card-view"><div class="narrator-slide">${row.narrator_text}</div></div>`;
            }
            else if (type === 'p') {
                const safeEnglish = (row.english || "").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                audioCallback = () => { playAudioThenTTS(safeEnglish); };
                const imgHtml = row.image_url ? `<img src="${row.image_url}" class="card-image">` : '';
                html = `<div class="card-view">
                        ${imgHtml}
                        ${renderMedia(row.audio_url)}
                        <div class="native-text" style="margin-bottom:20px;">${row.ayajuthem}</div>
                        <div class="hidden-content-box revealed" onclick="speak('${safeEnglish}')">
                            <div class="translation" style="font-size:1.5rem; color:var(--primary); font-weight:600;">${row.english}</div>
                        </div>
                    </div>`;
            }
            else if (type === 'r') {
                const safeEnglish = (row.english || "").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                audioCallback = () => { playCurrentSlideAudio(); };
                const imgHtml = row.image_url ? `<img src="${row.image_url}" class="card-image">` : '';
                html = `<div class="card-view">
                        ${imgHtml}
                        ${renderMedia(row.audio_url)}
                        <div class="native-text" style="margin-bottom:20px;">${row.ayajuthem}</div>
                        <div class="reveal-hint visible">[Tap to Reveal & Speak]</div>
                        <div class="hidden-content-box obscured" onclick="revealAndSpeak(this, '${safeEnglish}')">
                            <div class="translation" style="font-size:1.5rem; color:var(--primary); font-weight:600;">${row.english}</div>
                        </div>
                    </div>`;
            }
            else if (type === 't') {
                audioCallback = null;
                const imgHtml = row.image_url ? `<img src="${row.image_url}" class="card-image">` : '';
                html = `<div class="card-view">
                        ${imgHtml}
                        <div class="prompt-text">How would you say: <br>"${row.english}"?</div>
                        <div class="reveal-hint visible">[Click to Reveal & Play]</div>
                        <div class="hidden-content-box obscured" onclick="revealAndPlay(this)">
                            <div style="display:flex; justify-content:center; width:100%; margin-bottom:10px;">
                                ${renderMedia(row.audio_url)}
                            </div>
                            <div class="native-text">${row.ayajuthem}</div>
                        </div>
                    </div>`;
            }
            
            // Only show the narrator box if there is custom text (unless it's an 'n' slide content)
            if(textToSpeak && type !== 'n') narratorBox.style.display = 'flex';
        }
        // 4. FINISH
        else if (state.phase === 'finish') {
            updateButtons(false, "Finish");
            textToSpeak = "Lesson complete.";
            if (state.filename === 'review') textToSpeak = "";
            html = `<div style="text-align:center; margin-top:50px;"><h1>Done!</h1><p>Lesson Complete.</p></div>`;
        }

        container.innerHTML = html;
        if (textToSpeak) { 
            narratorEl.innerText = textToSpeak; 
            speak(textToSpeak, audioCallback); 
        } else { 
            narratorEl.innerText = ""; 
            if(audioCallback) audioCallback();
        }
    }
    window.speechSynthesis.onvoiceschanged = () => {};
</script>
</body>
</html>
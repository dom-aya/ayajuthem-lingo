<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayalingo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* GLOBAL FONTS & COLORS */
        :root {
            --primary: #2c3e50; 
            --accent: #27ae60; 
            --light: #ecf0f1;
            --speaker-a: #e8f6f3;
            --speaker-b: #fef9e7;
            --step-active: #3498db; 
            --blur-bg: #dfe6e9;
        }

        /* Enforce Segoe UI Everywhere */
        body, button, select, input, h1, h2, h3, h4, div, span, p, li, a {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        body { margin: 0; padding: 0; background: #f4f7f6; color: #333; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; border-radius: 0 0 16px 16px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        header h2 { margin: 0; font-weight: 700; letter-spacing: 1px; }

        /* PROGRESS BAR */
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 12px; margin-bottom: 20px; overflow: hidden; display:none; }
        .progress-bar { height: 100%; background-color: var(--accent); width: 0%; transition: width 0.3s ease; border-radius: 10px; }

        /* MENU GRID */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; width: 100%; margin-bottom: 20px; }
        .lesson-card {
            background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 0 #e5e5e5; border: 2px solid #e5e5e5;
            cursor: pointer; transition: transform 0.1s; text-align: center; position: relative;
        }
        .lesson-card:active { transform: translateY(4px); box-shadow: 0 0 0 #e5e5e5; }
        .lesson-card h3 { margin: 0; font-size: 1.1rem; color: var(--primary); }
        .lesson-card .status { font-size: 0.8rem; color: #95a5a6; margin-top: 5px; text-transform: uppercase; font-weight: bold; }
        .lesson-card.completed { border-color: var(--accent); background: #f0fdf4; box-shadow: 0 4px 0 #badcba; }
        .checkmark { position: absolute; top: 10px; right: 10px; color: var(--accent); font-weight: bold; font-size: 1.2rem; display: none; }
        .lesson-card.completed .checkmark { display: block; }
        
        /* REVIEW CARD */
        .lesson-card.review-card { border-color: var(--step-active); background: #eef9fe; box-shadow: 0 4px 0 #aecde0; }
        .lesson-card.review-card h3 { color: var(--step-active); }

        /* NARRATOR */
        #narrator-box { 
            background: #34495e; color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; 
            font-size: 0.95rem; display: none; align-items: center; gap: 15px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        #narrator-box:active { background: #2c3e50; transform: translateY(1px); }
        .tts-label { font-weight: bold; text-transform: uppercase; font-size: 0.7rem; color: #bdc3c7; margin-right: 10px; }
        .skip-hint { font-size: 0.7rem; color: #7f8c8d; margin-left: auto; opacity: 0.6; }

        /* MAIN CONTENT */
        #app-content { background: white; padding: 30px; border-radius: 16px; border: 2px solid #e5e5e5; box-shadow: 0 4px 0 #e5e5e5; flex-grow: 1; display: flex; flex-direction: column; position: relative; }

        /* CHAT VIEW */
        .chat-container { flex-grow: 1; margin-bottom: 20px; }
        .chat-row { margin-bottom: 15px; padding: 15px; border-radius: 12px; width: 90%; border: 2px solid #eee; transition: all 0.3s; }
        .speaker-A { background: var(--speaker-a); margin-right: auto; border-left: 5px solid #1abc9c; }
        .speaker-B { background: var(--speaker-b); margin-left: auto; border-right: 5px solid #f1c40f; }
        .chat-row.active-playing { border-color: var(--step-active); box-shadow: 0 0 10px rgba(52, 152, 219, 0.2); transform: scale(1.02); }

        /* CARD VIEW */
        .card-view { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; flex-grow: 1; }
        .narrator-slide { background: #fff; border-left: 6px solid var(--step-active); padding: 30px; border-radius: 12px; font-size: 1.3rem; line-height: 1.6; color: var(--primary); max-width: 600px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .hidden-content-box { background: transparent; border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer; width: 100%; }
        .hidden-content-box.obscured { background: var(--blur-bg); user-select: none; }
        .hidden-content-box.obscured .native-text, .hidden-content-box.obscured .translation, .hidden-content-box.obscured .media-container { visibility: hidden; opacity: 0; }
        .hidden-content-box.revealed .native-text, .hidden-content-box.revealed .translation, .hidden-content-box.revealed .media-container { visibility: visible; opacity: 1; }

        .native-text { font-size: 2rem; color: var(--primary); margin: 10px 0; font-weight: 700; }
        .translation { font-size: 1.3rem; color: #7f8c8d; font-style: italic; }
        .prompt-text { font-size: 1.1rem; margin-bottom: 20px; font-weight: bold; }
        .reveal-hint { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: #95a5a6; margin-bottom: 8px; opacity: 0; transition: opacity 0.3s; }
        .reveal-hint.visible { opacity: 1; }

        .card-image { max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 15px; object-fit: cover; }
        
        /* VISUALIZER */
        .visualizer-wrapper {
            position: relative;
            width: 100%;
            height: 80px;
            background: #f0f3f4;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        /* Hide default audio player since we have visualizer? 
           Actually, let's keep it hidden but present for functionality 
        */
        .slide-audio { display: none; } 

        
        /* ACTION BUTTONS */
        .main-action-container { margin-top: auto; padding-top: 20px; border-top: 2px solid #f0f0f0; text-align: center; display: flex; justify-content: center; gap: 10px; }
        .big-btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 700; text-transform: uppercase; box-shadow: 0 4px 0 #1a252f; transition: transform 0.1s; min-width: 120px; }
        .big-btn:active { transform: translateY(4px); box-shadow: none; }
        .big-btn:hover { filter: brightness(1.1); }
        
        .big-btn.secondary { background: white; color: #7f8c8d; border: 2px solid #e5e5e5; box-shadow: 0 4px 0 #e5e5e5; }
        .big-btn.secondary:active { box-shadow: none; }
        
        .stop-btn { background: #e74c3c; box-shadow: 0 4px 0 #c0392b; width: 100%; margin-top: 10px;}

        .reset-link { text-align: center; margin-top: 30px; font-size: 0.8rem; color: #95a5a6; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <h2>Ayalingo</h2>
</header>

<div class="container">
    
    <div id="menu-view">
        <div id="menu-grid" class="menu-grid"></div>
        <div class="reset-link" onclick="resetProgress()">Reset Progress</div>
    </div>

    <div id="progress-container" class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
    </div>

    <div id="narrator-box" onclick="skipTTS()">
        <span class="tts-label">Instructor</span>
        <span id="narrator-text"></span>
        <span class="skip-hint">(Tap to skip)</span>
    </div>

    <div id="app-content" style="display:none;"></div>
</div>

<script>
    // --- CONFIGURATION ---
    const lessonManifest = [
        "01_Greetings.csv",
        "02_Story.csv"
    ];

    // --- STATE ---
    let state = {
        conversationData: [], 
        sequenceData: [],     
        title: "",
        filename: "",
        goalsText: "", 
        phase: null,
        slideIndex: 0
    };

    let autoPlayActive = false; 
    let completedLessons = JSON.parse(localStorage.getItem('ayalingo_progress')) || [];
    let pendingAudioCallback = null; 
    
    // Audio Context for Visualizer
    let audioCtx;
    let analyser;
    let sourceNode;
    let animationFrameId;

    // --- INIT ---
    window.onload = () => { renderMenu(); };

    // --- VISUALIZER LOGIC ---
    function initAudioContext() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
        }
    }

    function connectAudioVisualizer(audioElement, canvasElement) {
        initAudioContext();
        
        // Re-use source node if possible, but audio elements change
        // Note: MediaElementSource can only be created once per element. 
        // We need to check if it's already connected or create a new one carefully.
        // Simplified: We assume a fresh render creates fresh DOM elements.
        
        try {
            sourceNode = audioCtx.createMediaElementSource(audioElement);
            sourceNode.connect(analyser);
            analyser.connect(audioCtx.destination);
        } catch(e) {
            // Already connected, ignore
        }

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const ctx = canvasElement.getContext("2d");

        function draw() {
            animationFrameId = requestAnimationFrame(draw);
            
            const width = canvasElement.width;
            const height = canvasElement.height;

            ctx.clearRect(0, 0, width, height);

            // 1. Draw Waveform (Frequency)
            analyser.getByteFrequencyData(dataArray);
            
            const barWidth = (width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i] / 2;
                ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`; // Reddish tint
                // Center the bars vertically
                const y = (height - barHeight) / 2;
                ctx.fillRect(x, y, barWidth, barHeight);
                x += barWidth + 1;
            }

            // 2. Draw Playhead Line
            if(audioElement.duration) {
                const progress = audioElement.currentTime / audioElement.duration;
                const playheadX = progress * width;
                
                ctx.beginPath();
                ctx.moveTo(playheadX, 0);
                ctx.lineTo(playheadX, height);
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }
        
        // Handle High DPI displays
        const dpr = window.devicePixelRatio || 1;
        const rect = canvasElement.getBoundingClientRect();
        canvasElement.width = rect.width * dpr;
        canvasElement.height = rect.height * dpr;
        ctx.scale(dpr, dpr);

        draw();
    }

    // --- MENU LOGIC ---
    function renderMenu() {
        const grid = document.getElementById('menu-grid');
        grid.innerHTML = "";
        
        lessonManifest.forEach(filename => {
            const cleanName = filename.replace('.csv', '').replace(/^\d+_/, '').replace(/_/g, ' ');
            const isDone = completedLessons.includes(filename);
            
            const card = document.createElement('div');
            card.className = `lesson-card ${isDone ? 'completed' : ''}`;
            card.onclick = () => loadLesson(filename);
            card.innerHTML = `<div class="checkmark">✓</div><h3>${cleanName}</h3><div class="status">${isDone ? 'Completed' : 'Start'}</div>`;
            grid.appendChild(card);
        });

        if (completedLessons.length > 0) {
            const reviewCard = document.createElement('div');
            reviewCard.className = `lesson-card review-card`;
            reviewCard.onclick = () => startReview();
            reviewCard.innerHTML = `<h3>Review</h3><div class="status" style="color:#3498db">Test Yourself</div>`;
            grid.appendChild(reviewCard);
        }

        switchView('menu');
    }

    function switchView(viewName) {
        document.getElementById('menu-view').style.display = viewName === 'menu' ? 'block' : 'none';
        document.getElementById('app-content').style.display = viewName === 'app' ? 'block' : 'none';
        document.getElementById('progress-container').style.display = viewName === 'app' ? 'block' : 'none';
        document.getElementById('narrator-box').style.display = 'none'; // reset
    }

    function resetProgress() {
        if(confirm("Are you sure you want to reset all progress?")) {
            localStorage.removeItem('ayalingo_progress');
            completedLessons = [];
            renderMenu();
        }
    }

    // --- LESSON LOADING ---
    function loadLesson(filename) {
        state.filename = filename;
        state.title = filename.replace('.csv', '').replace(/^\d+_/, '').replace(/_/g, ' ');

        const txtFile = filename.replace('.csv', '.txt');
        fetch(txtFile).then(r => r.ok ? r.text() : "Goals not available.").then(text => {
            state.goalsText = text;
            Papa.parse(filename, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    const raw = results.data;
                    state.conversationData = raw.filter(r => r.type && r.type.toLowerCase().trim() === 'c');
                    state.sequenceData = raw.filter(r => ['p', 'n', 'r', 't'].includes(r.type ? r.type.toLowerCase().trim() : ''));
                    switchView('app');
                    document.getElementById('narrator-box').style.display = 'flex';
                    transitionToPhase('goals');
                }
            });
        });
    }

    // --- REVIEW LOGIC ---
    async function startReview() {
        if (completedLessons.length === 0) return;
        state.filename = "review";
        state.title = "Review";
        state.goalsText = "Reviewing random items from your completed lessons.";
        state.conversationData = []; 
        
        let allItems = [];
        for (const file of completedLessons) {
            await new Promise(resolve => {
                Papa.parse(file, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => {
                        const items = res.data.filter(r => ['r', 't'].includes(r.type ? r.type.toLowerCase().trim() : ''));
                        allItems = allItems.concat(items);
                        resolve();
                    }
                });
            });
        }
        allItems.sort(() => 0.5 - Math.random());
        state.sequenceData = allItems.slice(0, 10);

        switchView('app');
        document.getElementById('narrator-box').style.display = 'flex';
        transitionToPhase('goals');
    }

    // --- NAVIGATION ---
    function transitionToPhase(newPhase) {
        stopConversationPlayback();
        cancelTTS();
        if(animationFrameId) cancelAnimationFrame(animationFrameId); // Stop visuals
        state.phase = newPhase;
        state.slideIndex = 0; 
        updateProgressBar();
        render();
    }

    function updateProgressBar() {
        const bar = document.getElementById('progress-bar');
        if (state.phase === 'goals') bar.style.width = '5%';
        else if (state.phase === 'conversation') bar.style.width = '15%';
        else if (state.phase === 'practice') {
            const pct = 15 + ((state.slideIndex / state.sequenceData.length) * 85);
            bar.style.width = `${pct}%`;
        } else if (state.phase === 'finish') bar.style.width = '100%';
    }

    function handleNextAction() {
        stopConversationPlayback();
        cancelTTS();

        if (state.phase === 'goals') {
            if(state.conversationData.length > 0) transitionToPhase('conversation');
            else transitionToPhase('practice');
        }
        else if (state.phase === 'conversation') {
            transitionToPhase('practice');
        }
        else if (state.phase === 'practice') {
            if (state.slideIndex < state.sequenceData.length - 1) {
                state.slideIndex++;
                updateProgressBar();
                render();
            } else {
                transitionToPhase('finish');
            }
        }
        else if (state.phase === 'finish') {
            if (state.filename !== 'review' && !completedLessons.includes(state.filename)) {
                completedLessons.push(state.filename);
                localStorage.setItem('ayalingo_progress', JSON.stringify(completedLessons));
            }
            renderMenu(); 
        }
    }

    function handlePrevAction() {
        stopConversationPlayback();
        cancelTTS();
        if (state.slideIndex > 0) {
            state.slideIndex--;
            updateProgressBar();
            render();
        }
    }

    // --- KEYBOARD SHORTCUTS ---
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('app-content').style.display === 'none') return;
        if (e.code === 'Space') {
            e.preventDefault();
            const hidden = document.querySelector('.hidden-content-box.obscured');
            if (hidden) hidden.click();
            else playCurrentSlideAudio();
        }
        if (e.code === 'ArrowRight') handleNextAction();
        if (e.code === 'ArrowLeft') handlePrevAction();
    });

    // --- VISUALIZER RENDERER ---
    function renderVisualizer(url) {
        if (!url) return '';
        const ytId = getYoutubeId(url);
        if (ytId) {
            return `<div class="media-container"><iframe width="100%" height="250" src="https://www.youtube.com/embed/${ytId}" frameborder="0" allowfullscreen></iframe></div>`;
        } else {
            // Return canvas AND hidden audio
            return `
                <div class="visualizer-wrapper">
                    <canvas id="viz-canvas"></canvas>
                </div>
                <audio class="slide-audio" src="${url}" crossorigin="anonymous"></audio>
            `;
        }
    }
    
    // Conversation mode doesn't need canvas per row, too heavy. Just standard.
    function renderSimpleMedia(url) {
        if (!url) return '';
        const ytId = getYoutubeId(url);
        if (ytId) return `<div class="media-container"><iframe width="100%" height="250" src="https://www.youtube.com/embed/${ytId}" frameborder="0" allowfullscreen></iframe></div>`;
        return `<div class="media-container"><audio class="convo-audio" controls src="${url}" style="width:100%;"></audio></div>`;
    }

    function getYoutubeId(url) {
        if (!url) return null;
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function playCurrentSlideAudio() {
        // Init Audio Context on first user interaction
        if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        
        const audio = document.querySelector('.slide-audio');
        const canvas = document.getElementById('viz-canvas');
        
        if (audio && canvas) {
            // Hook up visualizer if not already
            connectAudioVisualizer(audio, canvas);
            audio.play().catch(e => console.log("Audio play blocked", e));
        }
    }

    // --- AUTO-SEQUENCE ---
    function startConversationPlayback() {
        autoPlayActive = true;
        setTimeout(() => { playConversationIndex(0); }, 500);
    }
    function playConversationIndex(index) {
        if (!autoPlayActive) return;
        const rows = document.querySelectorAll('.chat-row');
        if (index >= rows.length) { autoPlayActive = false; return; }
        
        rows.forEach(r => r.classList.remove('active-playing'));
        const currentRow = rows[index];
        currentRow.classList.add('active-playing');
        currentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

        const audio = currentRow.querySelector('audio');
        if (audio) {
            audio.play().then(() => {
                audio.onended = () => { if(autoPlayActive) playConversationIndex(index + 1); };
            }).catch(() => { setTimeout(() => { if(autoPlayActive) playConversationIndex(index + 1); }, 2000); });
        } else {
            setTimeout(() => { if(autoPlayActive) playConversationIndex(index + 1); }, 3000);
        }
    }
    function stopConversationPlayback() {
        autoPlayActive = false;
        document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; a.onended = null; });
        document.querySelectorAll('.chat-row').forEach(r => r.classList.remove('active-playing'));
    }

    // --- TTS & CALLBACKS ---
    function speak(text, callback) {
        cancelTTS(); 
        if (!window.speechSynthesis) return;
        pendingAudioCallback = callback;
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.95;
        const voices = window.speechSynthesis.getVoices();
        const fVoice = voices.find(v => v.name.includes('Female') || v.name.includes('Google US English'));
        if (fVoice) u.voice = fVoice;
        u.onend = () => { if (pendingAudioCallback) { pendingAudioCallback(); pendingAudioCallback = null; } };
        window.speechSynthesis.speak(u);
    }
    function cancelTTS() { if (window.speechSynthesis) window.speechSynthesis.cancel(); pendingAudioCallback = null; }
    function skipTTS() { 
        if (window.speechSynthesis && window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
            if (pendingAudioCallback) { pendingAudioCallback(); pendingAudioCallback = null; }
        }
    }
    function revealAndPlay(element) {
        element.classList.remove('obscured'); element.classList.add('revealed');
        // Trigger visualizer play
        playCurrentSlideAudio();
    }

    // --- MAIN RENDER ---
    function render() {
        const container = document.getElementById('app-content');
        const narratorBox = document.getElementById('narrator-box');
        const narratorEl = document.getElementById('narrator-text');
        
        let textToSpeak = "";
        let html = "";
        let audioCallback = null; 

        narratorBox.style.display = 'flex';

        // 1. GOALS
        if (state.phase === 'goals') {
            textToSpeak = state.filename === 'review' ? "Review." : `Welcome to ${state.title}.`;
            const formattedGoals = state.goalsText.replace(/\n/g, '<br>');
            html = `
                <h2>Topic: ${state.title}</h2>
                <div style="font-size:1.1rem; line-height:1.6; margin-bottom:40px; text-align:left;">${formattedGoals}</div>
                <div class="main-action-container"><button class="big-btn" onclick="handleNextAction()">Start</button></div>`;
        } 
        // 2. CONVERSATION
        else if (state.phase === 'conversation') {
            textToSpeak = "Listen to the conversation.";
            html = `<div class="chat-container">`;
            state.conversationData.forEach((row, i) => {
                const spClass = row.speaker.includes('A') ? 'speaker-A' : 'speaker-B';
                html += `<div class="chat-row ${spClass}" id="row-${i}">
                    <span class="speaker-label">${row.speaker}</span>
                    <div style="font-size:1.1rem; margin-bottom: 5px;">${row.ayajuthem}</div>
                    <div style="font-size:0.9rem; color:#666; margin-bottom: 10px;">${row.english}</div>
                    ${renderSimpleMedia(row.audio_url)}
                </div>`;
            });
            html += `</div><div class="main-action-container" style="flex-direction:column;"><button class="big-btn" onclick="handleNextAction()">Practice</button><button class="big-btn secondary stop-btn" onclick="stopConversationPlayback()">Stop</button></div>`;
            setTimeout(() => { startConversationPlayback(); }, 100);
        }
        // 3. PRACTICE
        else if (state.phase === 'practice') {
            const row = state.sequenceData[state.slideIndex];
            const type = row.type.toLowerCase().trim();

            if (row.narrator_text && row.narrator_text.trim().length > 0) textToSpeak = row.narrator_text;
            else {
                if(type === 'n') textToSpeak = "Note.";
                else if(type === 'r') textToSpeak = "Recall.";
                else if(type === 't') textToSpeak = "How would you say this?";
                else if(type === 'p') textToSpeak = "Repeat.";
            }

            // NOTE ('n')
            if (type === 'n') {
                narratorBox.style.display = 'none'; // HIDE BOX
                html = `<div class="card-view"><div class="narrator-slide">${row.narrator_text}</div></div><div class="main-action-container"><button class="big-btn" onclick="handleNextAction()">Next</button></div>`;
            }
            // PRACTICE ('p') & RECALL ('r')
            else if (type === 'p' || type === 'r') {
                audioCallback = () => { playCurrentSlideAudio(); };
                const isRecall = (type === 'r');
                let contentClass = isRecall ? "hidden-content-box obscured" : "hidden-content-box";
                let hintClass = isRecall ? "reveal-hint visible" : "reveal-hint";
                let onClickAttr = isRecall ? `onclick="this.classList.remove('obscured'); this.classList.add('revealed')"` : "";
                const imgHtml = row.image_url ? `<img src="${row.image_url}" class="card-image">` : '';

                html = `
                    <div class="card-view">
                        ${imgHtml}
                        ${renderVisualizer(row.audio_url)}
                        <div class="${hintClass}">Tap to reveal</div>
                        <div class="${contentClass}" ${onClickAttr}>
                            <div class="native-text">${row.ayajuthem}</div>
                            <div class="translation">${row.english}</div>
                        </div>
                    </div>
                    <div class="main-action-container">
                        ${state.slideIndex > 0 ? `<button class="big-btn secondary" onclick="handlePrevAction()">Back</button>` : ''}
                        <button class="big-btn" onclick="handleNextAction()">Next</button>
                    </div>`;
            }
            // TEST ('t')
            else if (type === 't') {
                let contentClass = "hidden-content-box obscured";
                let onClickAttr = `onclick="revealAndPlay(this)"`;
                const imgHtml = row.image_url ? `<img src="${row.image_url}" class="card-image">` : '';

                html = `
                    <div class="card-view">
                        ${imgHtml}
                        <div class="prompt-text">How would you say: <br><span style="font-size:1.5rem; color:#4b4b4b">"${row.english}"</span>?</div>
                        <div class="reveal-hint visible">Tap to reveal & play</div>
                        <div class="${contentClass}" ${onClickAttr}>
                            ${renderVisualizer(row.audio_url)}
                            <div class="native-text">${row.ayajuthem}</div>
                        </div>
                    </div>
                    <div class="main-action-container">
                        ${state.slideIndex > 0 ? `<button class="big-btn secondary" onclick="handlePrevAction()">Back</button>` : ''}
                        <button class="big-btn" onclick="handleNextAction()">Next</button>
                    </div>`;
            }
        }
        // 4. FINISH
        else if (state.phase === 'finish') {
            textToSpeak = "Lesson complete.";
            html = `<div style="text-align:center; margin-top:50px;"><h1 style="font-size:3rem; margin-bottom: 20px; color: var(--accent);">✓</h1><h2>Lesson Complete</h2><div class="main-action-container"><button class="big-btn" onclick="handleNextAction()">Return to Menu</button></div></div>`;
        }

        container.innerHTML = html;
        if (textToSpeak) { narratorEl.innerText = textToSpeak; speak(textToSpeak, audioCallback); } 
        else { narratorEl.innerText = "..."; }
    }

    window.speechSynthesis.onvoiceschanged = () => {};
</script>

</body>
</html>
